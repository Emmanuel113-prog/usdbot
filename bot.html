<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>NUCH BOT — Matches / Differs (Most Frequent Digit)</title>
  <style>
    :root{
      --bg:#070812; --card:#0f1420; --muted:#9aa3b2; --accent:#00e0ff;
      --green:#28a745; --red:#dc3545; --glass: rgba(255,255,255,0.03);
      --panel-radius:12px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,Segoe UI,Arial,sans-serif;background:linear-gradient(180deg,#02030a 0%, #071022 100%);color:#e6eef6}
    .container{max-width:1100px;margin:20px auto;padding:18px;display:grid;grid-template-columns:360px 1fr;gap:18px}
    .panel{background:linear-gradient(180deg,var(--card),#0b1320);border-radius:var(--panel-radius);padding:16px;box-shadow:0 8px 30px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.03)}
    h1{margin:0;font-size:18px;color:var(--accent);font-weight:800}
    .subtitle{color:var(--muted);font-size:13px;margin-bottom:10px}
    label{display:block;font-size:13px;color:var(--muted);margin-top:10px}
    input[type="text"], input[type="password"], input[type="number"], select {
      width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:#08101a;color:#e6eef6;font-size:14px;
    }
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .btn{width:100%;padding:10px;border-radius:10px;border:none;cursor:pointer;font-weight:800}
    .btn-start{background:linear-gradient(90deg,var(--green),#1fa84a);color:#04220f}
    .btn-stop{background:linear-gradient(90deg,#dc3545,#b72828);color:#fff}
    .stat-big{font-size:20px;font-weight:900;color:var(--accent)}
    .small{font-size:12px;color:var(--muted)}
    #circle{width:140px;height:140px;border-radius:50%;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:52px;font-weight:900;color:#fff;background:linear-gradient(180deg,#111827,#08101b);margin:auto}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:8px 8px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:center}
    th{color:var(--muted);font-weight:700;font-size:12px}
    .log-wrap{height:300px;overflow:auto;padding-top:6px}
    .controls-row{display:flex;gap:8px}
    .switch {display:flex;align-items:center;gap:8px}
    .banner-wrap{overflow:hidden;padding:10px 0;background:transparent}
    .banner {
      display:inline-block;
      white-space:nowrap;
      padding-left:100%;
      font-weight:800;
      font-size:18px;
      animation: moveLeft 12s linear infinite, colorShift 4s linear infinite;
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;
      background:linear-gradient(90deg, #ff005a, #ff7a00, #ffd400, #2cff6e, #00d1ff, #7a5cff);
      background-size:400% 400%;
    }
    @keyframes moveLeft { 0% { transform: translateX(0%);} 100% { transform: translateX(-100%);} }
    @keyframes colorShift { 0% { background-position:0% 50% } 50% { background-position:100% 50% } 100% { background-position:0% 50% } }
    @media(max-width:980px){.container{grid-template-columns:1fr; padding:12px} #circle{width:120px;height:120px;font-size:44px}}
  </style>
</head>
<body>
  <div class="banner-wrap" style="text-align:center">
    <div class="banner">By Nuch Contact 0769769295 for more information</div>
  </div>

  <div class="container">
    <div class="panel">
      <h1>NUCH BOT — MATCHES / DIFFERS</h1>
      <div class="subtitle">Most-appearing digit strategy (auto-select barrier)</div>

      <label>Total Profit</label>
      <div style="display:flex;gap:8px;align-items:center">
        <div class="stat-big" id="totalProfit">$0.00</div>
        <div class="small" id="sessionInfo">Trades: 0 • Loss Streak: 0</div>
      </div>

      <label>Deriv API Token</label>
      <input id="token" type="password" placeholder="Your API token" />

      <div class="grid2">
        <div>
          <label>Market (symbol)</label>
          <input id="market" type="text" value="1HZ100V" />
        </div>
        <div>
          <label>Tick window (M)</label>
          <input id="window" type="number" min="3" max="200" value="30" />
          <div class="small">Number of last ticks used to compute most frequent digit</div>
        </div>
      </div>

      <label>Contract Type</label>
      <select id="contractType">
        <option value="DIGITMATCH">Matches (DIGITMATCH)</option>
        <option value="DIGITDIFF">Differs (DIGITDIFF)</option>
      </select>

      <div class="grid2">
        <div>
          <label>Base Stake ($)</label>
          <input id="stake" type="number" min="0.01" step="0.01" value="0.35" />
        </div>
        <div>
          <label>Current Stake (read-only)</label>
          <input id="currentStake" type="text" readonly value="$0.35" />
        </div>
      </div>

      <label>Stop options</label>
      <div style="display:flex;gap:8px;flex-direction:column">
        <div style="display:flex;gap:8px">
          <label><input type="checkbox" id="stopOnProfit" /> Stop on profit ≥</label>
          <input id="profitLimit" type="number" min="0.01" step="0.01" value="2" style="width:100px" />
        </div>
        <div style="display:flex;gap:8px">
          <label><input type="checkbox" id="stopOnLoss" /> Stop on loss ≤</label>
          <input id="lossLimit" type="number" min="0.01" step="0.01" value="5" style="width:100px" />
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <label style="margin:0"><input type="checkbox" id="stopOnSingleLoss" /> Stop after a single losing trade</label>
        </div>
      </div>

      <label>Alerts</label>
      <div style="display:flex;gap:8px;align-items:center">
        <label style="margin:0"><input type="checkbox" id="voiceAlert" /> Voice alert on win/loss</label>
      </div>

      <div style="display:flex;gap:10px;margin-top:12px">
        <button class="btn btn-start" id="startBtn">Start</button>
        <button class="btn btn-stop" id="stopBtn">Stop</button>
      </div>

      <div style="margin-top:12px" class="small">Mini log</div>
      <div id="miniLog" style="height:140px;overflow:auto;margin-top:8px;padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);font-size:13px"></div>
    </div>

    <div class="panel" style="display:flex;flex-direction:column;gap:12px">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
        <div style="font-weight:800">Live Visual</div>
        <div style="font-size:13px;color:var(--muted)">Symbol: <span id="liveSymbol">1HZ100V</span></div>
      </div>

      <div style="display:flex;gap:18px;align-items:center">
        <div style="flex:0 0 180px;text-align:center">
          <div id="circle"><div id="circleDigit">-</div></div>
          <div id="predictionLabel" style="margin-top:8px;text-align:center">Barrier: <strong id="barrierText">—</strong></div>
        </div>

        <div style="flex:1">
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <div class="small">Trades: <strong id="tradeCount">0</strong></div>
            <div class="small">Loss Streak: <strong id="lossStreak">0</strong></div>
            <div class="small">Waiting: <strong id="waitingFlag">No</strong></div>
            <div class="small">Window size: <strong id="windowSize">30</strong></div>
          </div>

          <div style="margin-top:12px">
            <div style="font-weight:800;margin-bottom:6px">Digit frequencies (latest window)</div>
            <div id="freqBars" style="display:grid;grid-template-columns:repeat(5,1fr);gap:6px;font-size:13px"></div>
          </div>
        </div>
      </div>

      <div style="font-weight:800;margin-top:6px">Trade Log</div>
      <div class="log-wrap">
        <table id="logTable">
          <thead>
            <tr><th>#</th><th class="small">Time</th><th>Barrier</th><th>Prediction</th><th>Stake</th><th>Result</th><th>P/L</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div style="margin-top:6px;font-size:12px;color:var(--muted)">
        Notes: Bot picks the most frequent digit from the last M ticks as the barrier. You can choose Matches or Differs contract. Configure stop-on-profit/loss and voice alerts.
      </div>
    </div>
  </div>

  <script>
    let ws = null;
    const state = {
      token: '',
      market: '1HZ100V',
      window: 30,
      ticks: [],
      isRunning: false,
      currentStake: 0.35,
      baseStake: 0.35,
      tradeCount: 0,
      lossStreak: 0,
      totalProfit: 0,
      waitingResult: false,
      contractId: null,
      lastBarrier: null
    };

    const miniLog = document.getElementById('miniLog');
    const totalProfitEl = document.getElementById('totalProfit');
    const sessionInfoEl = document.getElementById('sessionInfo');
    const circleDigitEl = document.getElementById('circleDigit');
    const barrierText = document.getElementById('barrierText');
    const tradeCountEl = document.getElementById('tradeCount');
    const lossStreakEl = document.getElementById('lossStreak');
    const waitingFlagEl = document.getElementById('waitingFlag');
    const freqBars = document.getElementById('freqBars');
    const windowSizeEl = document.getElementById('windowSize');
    const logTableBody = document.querySelector('#logTable tbody');

    function addMini(msg){ 
      const t = new Date().toLocaleTimeString(); 
      miniLog.innerHTML = `<div style="margin-bottom:6px"><strong>[${t}]</strong> ${msg}</div>` + miniLog.innerHTML;
    }

    function addLogRow(entry){ 
      state.tradeCount += 1; 
      const tr = document.createElement('tr'); 
      tr.innerHTML = `<td>${state.tradeCount}</td><td class="small">${entry.time}</td><td>${entry.barrier}</td><td>${entry.prediction}</td><td>$${entry.stake.toFixed(2)}</td><td>${entry.result}</td><td>$${entry.profit.toFixed(2)}</td>`; 
      logTableBody.prepend(tr);
    }

    function updateUI(){ 
      totalProfitEl.textContent = `$${state.totalProfit.toFixed(2)}`; 
      sessionInfoEl.textContent = `Trades: ${state.tradeCount} • Loss Streak: ${state.lossStreak}`; 
      tradeCountEl.textContent = `${state.tradeCount}`; 
      lossStreakEl.textContent = `${state.lossStreak}`; 
      waitingFlagEl.textContent = state.waitingResult ? 'Yes' : 'No'; 
      document.getElementById('currentStake').value = `$${state.currentStake.toFixed(2)}`; 
      document.getElementById('liveSymbol').textContent = state.market; 
      windowSizeEl.textContent = state.window;
    }

    function speak(text){
      if(!('speechSynthesis' in window)) return;
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = 'en-US';
      window.speechSynthesis.speak(utter);
    }

    function computeFrequencies(){ 
      const freq = new Array(10).fill(0); 
      state.ticks.forEach(d => { 
        if(typeof d === 'number') freq[d]++; 
      }); 
      return freq;
    }

    function mostFrequentDigit(){ 
      const freq = computeFrequencies(); 
      let best = 0, bestDigit = null; 
      for(let i = 0; i < freq.length; i++){ 
        if(freq[i] > best){ 
          best = freq[i]; 
          bestDigit = i; 
        } 
      } 
      return {digit: bestDigit, freq};
    }

    function renderFreqBars(){ 
      const {digit, freq} = mostFrequentDigit(); 
      freqBars.innerHTML = ''; 
      const maxVal = Math.max(...freq, 1); 
      for(let i = 0; i < 10; i++){ 
        const pct = Math.round((freq[i] / maxVal) * 100); 
        const el = document.createElement('div'); 
        el.style.padding = '6px'; 
        el.style.borderRadius = '8px'; 
        el.style.background = i === digit ? 'linear-gradient(90deg,#ffd54d,#ff6b6b)' : 'rgba(255,255,255,0.02)'; 
        el.innerHTML = `<div style="font-weight:800">${i}</div><div style="font-size:11px;color:var(--muted)">${freq[i]}</div>`; 
        freqBars.appendChild(el); 
      }
    }

    function startBot(){
      state.token = document.getElementById('token').value.trim();
      state.market = (document.getElementById('market').value || '1HZ100V').trim();
      state.window = parseInt(document.getElementById('window').value) || 30;
      state.baseStake = parseFloat(document.getElementById('stake').value) || 0.35;
      state.currentStake = state.baseStake;
      state.ticks = []; 
      state.isRunning = true; 
      state.tradeCount = 0; 
      state.lossStreak = 0; 
      state.totalProfit = 0; 
      state.waitingResult = false; 
      state.lastBarrier = null;
      logTableBody.innerHTML = '';
      
      if(!state.token){
        alert('Enter valid API token'); 
        return;
      }
      
      addMini('Starting Matches/Differs bot...');
      connectWebsocket(); 
      updateUI();
    }

    function stopBot(){ 
      state.isRunning = false; 
      if(ws){
        try{
          ws.close();
        }catch(e){}
      } 
      addMini('Bot stopped.'); 
      updateUI(); 
    }

    function connectWebsocket(){
      ws = new WebSocket('wss://ws.binaryws.com/websockets/v3?app_id=1089');
      
      ws.onopen = () => { 
        addMini('[WS] Connected'); 
        ws.send(JSON.stringify({authorize: state.token})); 
      };
      
      ws.onerror = (e) => { 
        addMini('[WS] Error'); 
        console.error(e); 
      };
      
      ws.onclose = (ev) => { 
        addMini('[WS] Closed'); 
        state.waitingResult = false; 
        updateUI(); 
        if(state.isRunning){ 
          setTimeout(() => { 
            addMini('[WS] Reconnecting...'); 
            connectWebsocket(); 
          }, 3000); 
        } 
      };
      
      ws.onmessage = (msg) => { 
        try{ 
          const data = JSON.parse(msg.data); 
          if(data.error){ 
            addMini('[ERROR] ' + (data.error.message || JSON.stringify(data.error))); 
            if(data.error && data.error.code === 'AuthorizationRequired') stopBot(); 
            return;
          } 
          handleWsMessage(data);
        }catch(err){
          console.error('parse error', err);
        } 
      };
    }

    function handleWsMessage(data){
      if(data.msg_type === 'authorize'){ 
        addMini('[BOT] Authorized. Subscribing ticks: ' + state.market); 
        ws.send(JSON.stringify({ticks: state.market, subscribe: 1})); 
        return; 
      }
      
      if(data.msg_type === 'tick'){ 
        const quote = data.tick && data.tick.quote; 
        if(quote === undefined) return; 
        const digit = parseInt(String(quote).slice(-1)); 
        onNewTick(digit); 
        return; 
      }
      
      if(data.msg_type === 'buy'){ 
        if(data.buy && data.buy.contract_id){ 
          state.contractId = data.buy.contract_id; 
          addMini(`[TRADE] Bought contract ${state.contractId}`); 
          ws.send(JSON.stringify({
            proposal_open_contract: 1,
            contract_id: state.contractId,
            subscribe: 1
          })); 
        } else{ 
          addMini('[ERROR] Buy failed'); 
          state.waitingResult = false; 
          updateUI();
        } 
        return; 
      }
      
      if(data.msg_type === 'proposal_open_contract'){ 
        const open = data.proposal_open_contract; 
        if(!open) return; 
        if(open.is_sold){ 
          const profit = parseFloat(open.profit) || 0; 
          let entryBarrier = state.lastBarrier; 
          try{ 
            if((!entryBarrier || entryBarrier === null) && open.entry_tick) 
              entryBarrier = parseInt(String(open.entry_tick).slice(-1)); 
          }catch(e){} 
          handleContractResult(profit, entryBarrier);
        }
        return; 
      }
    }

    function onNewTick(digit){
      if(!state.isRunning) return;
      
      // Add new digit to ticks array
      state.ticks.push(digit);
      
      // Keep only the last 'window' ticks
      if(state.ticks.length > state.window){
        state.ticks = state.ticks.slice(-state.window);
      }
      
      // Update circle display
      circleDigitEl.textContent = digit;
      
      // Render frequency bars
      renderFreqBars();
      
      // If not waiting for result and have enough data, place trade
      if(!state.waitingResult && state.ticks.length >= state.window){
        placeTrade();
      }
    }

    function placeTrade(){
      const {digit} = mostFrequentDigit();
      if(digit === null) return;
      
      state.lastBarrier = digit;
      state.waitingResult = true;
      
      const contractType = document.getElementById('contractType').value;
      const prediction = contractType === 'DIGITMATCH' ? 'Matches' : 'Differs';
      
      addMini(`[TRADE] Placing ${prediction} trade with barrier ${digit}, stake $${state.currentStake.toFixed(2)}`);
      
      // Update barrier display
      barrierText.textContent = digit;
      
      // Send buy request
      ws.send(JSON.stringify({
        buy: 1,
        price: state.currentStake,
        parameters: {
          amount: state.currentStake,
          basis: 'stake',
          contract_type: contractType,
          currency: 'USD',
          duration: 1,
          duration_unit: 't',
          symbol: state.market,
          barrier: digit.toString()
        }
      }));
      
      updateUI();
    }

    function handleContractResult(profit, barrier){
      state.waitingResult = false;
      
      const contractType = document.getElementById('contractType').value;
      const prediction = contractType === 'DIGITMATCH' ? 'Matches' : 'Differs';
      const isWin = profit > 0;
      const result = isWin ? 'WIN' : 'LOSS';
      
      // Update stats
      state.totalProfit += profit;
      
      if(isWin){
        state.lossStreak = 0;
        state.currentStake = state.baseStake; // Reset to base stake after win
      } else {
        state.lossStreak++;
        // Martingale: double stake after loss
        state.currentStake = state.currentStake * 2;
      }
      
      // Add to log
      const logEntry = {
        time: new Date().toLocaleTimeString(),
        barrier: barrier || state.lastBarrier || '?',
        prediction: prediction,
        stake: state.currentStake / (isWin ? 1 : 2), // Show original stake
        result: result,
        profit: profit
      };
      
      addLogRow(logEntry);
      
      // Voice alert
      const voiceAlert = document.getElementById('voiceAlert').checked;
      if(voiceAlert){
        speak(isWin ? 'Trade won' : 'Trade lost');
      }
      
      // Check stop conditions
      checkStopConditions();
      
      addMini(`[RESULT] ${result} - P/L: $${profit.toFixed(2)} - Total: $${state.totalProfit.toFixed(2)}`);
      updateUI();
    }

    function checkStopConditions(){
      const stopOnProfit = document.getElementById('stopOnProfit').checked;
      const profitLimit = parseFloat(document.getElementById('profitLimit').value) || 0;
      const stopOnLoss = document.getElementById('stopOnLoss').checked;
      const lossLimit = parseFloat(document.getElementById('lossLimit').value) || 0;
      const stopOnSingleLoss = document.getElementById('stopOnSingleLoss').checked;
      
      if(stopOnProfit && state.totalProfit >= profitLimit){
        addMini(`[STOP] Profit target reached: $${state.totalProfit.toFixed(2)}`);
        stopBot();
        return;
      }
      
      if(stopOnLoss && state.totalProfit <= -lossLimit){
        addMini(`[STOP] Loss limit reached: $${state.totalProfit.toFixed(2)}`);
        stopBot();
        return;
      }
      
      if(stopOnSingleLoss && state.lossStreak >= 1){
        addMini('[STOP] Single loss stop triggered');
        stopBot();
        return;
      }
    }

    // Event listeners
    document.getElementById('startBtn').addEventListener('click', startBot);
    document.getElementById('stopBtn').addEventListener('click', stopBot);

    // Initialize UI
    updateUI();
    renderFreqBars();
  </script>
</body>
</html>